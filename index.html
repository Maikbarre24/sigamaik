<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributore Bluetooth e QR</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f4f4f9;
        }
        h1 {
            color: #333;
        }
        .option {
            margin: 10px;
        }
        #devices, #qrScanner {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            width: 300px;
            text-align: center;
            font-size: 1.1em;
        }
        button {
            padding: 10px 20px;
            font-size: 1em;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        input {
            padding: 10px;
            font-size: 1em;
            width: 300px;
            margin: 10px 0;
        }
        #qrReader {
            width: 300px;
            height: 300px;
            margin-top: 10px;
        }
        #selectionPanel {
            margin-top: 20px;
            display: none;
        }
        #selectionPanel button {
            margin: 5px;
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>Distributore Bluetooth e QR</h1>

    <div class="option">
        <button id="bluetoothOption">Connetti tramite Bluetooth</button>
        <button id="qrOption">Connetti tramite QR</button>
    </div>

    <div id="bluetoothInterface" style="display:none;">
        <h3>Connessione Bluetooth</h3>
        <button id="scanButton">Scansiona dispositivi Bluetooth</button>
        <div id="devices"></div>
    </div>

    <div id="qrInterface" style="display:none;">
        <h3>Connessione tramite QR</h3>
        <div id="qrScanner">
            <div id="qrReader"></div>
            <p id="qrResult">Scansiona un codice QR...</p>
        </div>
    </div>

    <div id="controlPanel" style="display:none;">
        <h3>Comando al Distributore</h3>
        <div id="selectionPanel">
            <h4>Seleziona un'azione:</h4>
            <button class="itemButton" data-item="Sigaretta 1">Sigaretta 1</button>
            <button class="itemButton" data-item="Sigaretta 2">Sigaretta 2</button>
            <button class="itemButton" data-item="Sigaretta 3">Sigaretta 3</button>
        </div>
        <input type="text" id="commandInput" placeholder="Inserisci un comando personalizzato">
        <button id="sendCommand">Invia Comando</button>
        <p id="response" style="margin-top: 10px; color: green;"></p>
    </div>

    <script>
        let connectedDevice = null;
        let deviceServer = null;
        let writeCharacteristic = null;
        const qrReader = new Html5Qrcode("qrReader");

        const bluetoothOption = document.getElementById('bluetoothOption');
        const qrOption = document.getElementById('qrOption');
        const bluetoothInterface = document.getElementById('bluetoothInterface');
        const qrInterface = document.getElementById('qrInterface');
        const scanButton = document.getElementById('scanButton');
        const devicesDiv = document.getElementById('devices');
        const controlPanel = document.getElementById('controlPanel');
        const selectionPanel = document.getElementById('selectionPanel');
        const sendCommandButton = document.getElementById('sendCommand');
        const responseParagraph = document.getElementById('response');
        const commandInput = document.getElementById('commandInput');
        const qrResult = document.getElementById('qrResult');

        // Mostra interfaccia Bluetooth
        bluetoothOption.addEventListener('click', () => {
            bluetoothInterface.style.display = 'block';
            qrInterface.style.display = 'none';
        });

        // Mostra interfaccia QR
        qrOption.addEventListener('click', () => {
            bluetoothInterface.style.display = 'none';
            qrInterface.style.display = 'block';
            startQRScanner();
        });

        // Scansione dispositivi Bluetooth
        scanButton.addEventListener('click', async () => {
            try {
                devicesDiv.innerHTML = "Scansione in corso...";
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: []
                });

                devicesDiv.innerHTML = `Trovato dispositivo: ${device.name || 'Sconosciuto'}<br>Connettendo...`;
                connectedDevice = device;

                deviceServer = await device.gatt.connect();
                const services = await deviceServer.getPrimaryServices();
                for (const service of services) {
                    const characteristics = await service.getCharacteristics();
                    for (const characteristic of characteristics) {
                        if (characteristic.properties.write) {
                            writeCharacteristic = characteristic;
                            break;
                        }
                    }
                    if (writeCharacteristic) break;
                }

                if (writeCharacteristic) {
                    devicesDiv.innerHTML = `Connesso a: ${device.name || 'Sconosciuto'}`;
                    controlPanel.style.display = 'block';
                    selectionPanel.style.display = 'block';
                } else {
                    devicesDiv.innerHTML = "Nessuna caratteristica scrivibile trovata.";
                }
            } catch (error) {
                devicesDiv.innerHTML = `Errore durante la scansione: ${error.message}`;
            }
        });

        // Invio comando
        sendCommandButton.addEventListener('click', async () => {
            const command = commandInput.value;
            if (!command) {
                responseParagraph.textContent = "Errore: comando vuoto!";
                responseParagraph.style.color = 'red';
                return;
            }

            if (!writeCharacteristic) {
                responseParagraph.textContent = `Comando inviato (ma senza caratteristica scrivibile): "${command}"`;
                responseParagraph.style.color = 'orange';
                return;
            }

            try {
                const encoder = new TextEncoder();
                await writeCharacteristic.writeValue(encoder.encode(command));
                responseParagraph.textContent = `Comando inviato: "${command}"`;
                responseParagraph.style.color = 'green';
            } catch (error) {
                responseParagraph.textContent = `Errore nell'invio: ${error.message}`;
                responseParagraph.style.color = 'red';
            }
        });

        // Pulsanti predefiniti
        document.querySelectorAll('.itemButton').forEach(button => {
            button.addEventListener('click', async (event) => {
                const item = event.target.getAttribute('data-item');
                if (!writeCharacteristic) {
                    responseParagraph.textContent = `Comando inviato (ma senza caratteristica scrivibile): "${item}"`;
                    responseParagraph.style.color = 'orange';
                    return;
                }
                try {
                    const encoder = new TextEncoder();
                    await writeCharacteristic.writeValue(encoder.encode(item));
                    responseParagraph.textContent = `Comando inviato: "${item}"`;
                    responseParagraph.style.color = 'green';
                } catch (error) {
                    responseParagraph.textContent = `Errore nell'invio: ${error.message}`;
                    responseParagraph.style.color = 'red';
                }
            });
        });

        // Inizio scansione QR
        function startQRScanner() {
            qrReader.start({ facingMode: "environment" }, {
                fps: 10,
                qrbox: 250
            }, (decodedText, decodedResult) => {
                qrResult.textContent = `QR Scansionato: ${decodedText}`;
                qrReader.stop();
                controlPanel.style.display = 'block';
                selectionPanel.style.display = 'block';
            }, (errorMessage) => {
                console.error(errorMessage);
            }).catch(err => {
                qrResult.textContent = `Errore nel QR scanner: ${err.message}`;
            });
        }
    </script>
</body>
</html>
